@inject IEncoderService EncoderService
@inject IJSRuntime JS
@inject INoteService NoteService
@inject INavigationService NavigationService

<div class="encoder-panel"
     @onmousemove="OnMouseMove"
     @onmouseup="StopResize"
     @onmouseleave="StopResize">
    <div class="encoder-toolbar">
        <button class="toolbar-btn" @onclick="LoadFromClipboard" title="Load from clipboard">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
            </svg>
            Paste
        </button>
        <button class="toolbar-btn" @onclick="SwapInputOutput" title="Swap input and output" disabled="@string.IsNullOrEmpty(_output)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
            </svg>
            Swap
        </button>
        <button class="toolbar-btn" @onclick="CopyOutput" title="Copy output to clipboard" disabled="@string.IsNullOrEmpty(_output)">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6z"/>
                <path d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>
            </svg>
            Copy
        </button>
        <button class="toolbar-btn" @onclick="Clear" title="Clear all">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
            </svg>
            Clear
        </button>

        @if (_copied)
        {
            <span class="copy-indicator">Copied!</span>
        }
    </div>

    <div class="encoder-content">
        <div class="encoder-input-section" style="@GetInputStyle()">
            <label class="section-label">Input</label>
            <textarea class="encoder-textarea"
                      @bind="_input"
                      @bind:event="oninput"
                      placeholder="Enter text to encode/decode..."></textarea>

            <div class="encoder-operations">
            <div class="operation-group">
                <span class="group-label">Base64</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.Base64Encode(_input))">Encode</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.Base64Decode(_input))">Decode</button>
                </div>
            </div>

            <div class="operation-group">
                <span class="group-label">URL</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.UrlEncode(_input))">Encode</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.UrlDecode(_input))">Decode</button>
                </div>
            </div>

            <div class="operation-group">
                <span class="group-label">HTML</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HtmlEncode(_input))">Encode</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HtmlDecode(_input))">Decode</button>
                </div>
            </div>

            <div class="operation-group">
                <span class="group-label">Hex</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HexEncode(_input))">Encode</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HexDecode(_input))">Decode</button>
                </div>
            </div>

            <div class="operation-group">
                <span class="group-label">Unicode</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.UnicodeEscape(_input))">Escape</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.UnicodeUnescape(_input))">Unescape</button>
                </div>
            </div>

            <div class="operation-group">
                <span class="group-label">Hash</span>
                <div class="operation-buttons">
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HashMd5(_input))">MD5</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HashSha256(_input))">SHA256</button>
                    <button class="op-btn" @onclick="() => Execute(() => EncoderService.HashSha512(_input))">SHA512</button>
                </div>
            </div>

            <div class="operation-group jwt-group">
                <span class="group-label">JWT</span>
                <div class="operation-buttons">
                    <button class="op-btn op-btn-wide" @onclick="DecodeJwt">Decode JWT</button>
                </div>
            </div>
            </div>
        </div>

        <div class="encoder-resizer"
             @onmousedown="StartResize"
             @onmousedown:preventDefault>
            <div class="resizer-handle"></div>
        </div>

        <div class="encoder-output-section">
            <div class="output-header">
                <label class="section-label">
                    Output
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <span class="error-badge">Error</span>
                    }
                    @if (_jwtResult != null && _jwtResult.Success)
                    {
                        <span class="jwt-badge @(_jwtResult.IsExpired ? "expired" : "valid")">
                            @(_jwtResult.IsExpired ? "Expired" : "Valid")
                        </span>
                    }
                </label>
                <div class="output-actions">
                    <button class="output-btn" @onclick="CopyOutput" disabled="@(!HasOutput)" title="Copy to clipboard">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>
                        </svg>
                        Copy
                    </button>
                    <button class="output-btn" @onclick="SaveToNote" disabled="@(!HasOutput)" title="Save to new note">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                        </svg>
                        Save to Note
                    </button>
                </div>
            </div>

            @if (_jwtResult != null && _jwtResult.Success)
            {
                <div class="jwt-output">
                    <div class="jwt-section">
                        <div class="jwt-section-header">Header</div>
                        <pre class="jwt-json">@_jwtResult.HeaderJson</pre>
                    </div>
                    <div class="jwt-section">
                        <div class="jwt-section-header">
                            Payload
                            @if (_jwtResult.ExpiresAt.HasValue)
                            {
                                <span class="jwt-expiry">
                                    Expires: @_jwtResult.ExpiresAt.Value.ToLocalTime().ToString("g")
                                </span>
                            }
                        </div>
                        <pre class="jwt-json">@_jwtResult.PayloadJson</pre>
                    </div>
                    @if (!string.IsNullOrEmpty(_jwtResult.Signature))
                    {
                        <div class="jwt-section">
                            <div class="jwt-section-header">Signature</div>
                            <pre class="jwt-signature">@_jwtResult.Signature</pre>
                        </div>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(_error))
            {
                <div class="encoder-error">@_error</div>
            }
            else
            {
                <textarea class="encoder-textarea output"
                          readonly
                          @bind="_output"
                          placeholder="Output will appear here..."></textarea>
            }
        </div>
    </div>
</div>

@code {
    private string _input = "";
    private string _output = "";
    private string? _error;
    private JwtDecodeResult? _jwtResult;
    private bool _copied;
    private bool _isResizing;
    private double _inputHeightPercent = 55; // Default 55% for input + operations

    private bool HasOutput => !string.IsNullOrEmpty(_output) || (_jwtResult != null && _jwtResult.Success);

    private void Execute(Func<string> operation)
    {
        _error = null;
        _jwtResult = null;
        _output = "";

        if (string.IsNullOrEmpty(_input))
        {
            _error = "Please enter some text to process";
            return;
        }

        try
        {
            _output = operation();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private void DecodeJwt()
    {
        _error = null;
        _output = "";

        if (string.IsNullOrEmpty(_input))
        {
            _error = "Please enter a JWT token";
            return;
        }

        _jwtResult = EncoderService.DecodeJwt(_input);
        if (!_jwtResult.Success)
        {
            _error = _jwtResult.Error;
            _jwtResult = null;
        }
    }

    private async Task LoadFromClipboard()
    {
        try
        {
            _input = await JS.InvokeAsync<string>("navigator.clipboard.readText");
            _error = null;
            _output = "";
            _jwtResult = null;
        }
        catch
        {
            _error = "Unable to read from clipboard";
        }
    }

    private void SwapInputOutput()
    {
        if (!string.IsNullOrEmpty(_output))
        {
            _input = _output;
            _output = "";
            _error = null;
            _jwtResult = null;
        }
    }

    private async Task CopyOutput()
    {
        string textToCopy = _output;

        // For JWT, copy the formatted payload
        if (_jwtResult != null && _jwtResult.Success)
        {
            textToCopy = _jwtResult.PayloadJson ?? "";
        }

        if (!string.IsNullOrEmpty(textToCopy))
        {
            try
            {
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", textToCopy);
                _copied = true;
                StateHasChanged();

                await Task.Delay(2000);
                _copied = false;
                StateHasChanged();
            }
            catch { }
        }
    }

    private void Clear()
    {
        _input = "";
        _output = "";
        _error = null;
        _jwtResult = null;
    }

    private string GetInputStyle()
    {
        return $"flex: 0 0 {_inputHeightPercent}%;";
    }

    private void StartResize(MouseEventArgs e)
    {
        _isResizing = true;
    }

    private void StopResize(MouseEventArgs e)
    {
        _isResizing = false;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (!_isResizing) return;

        // Calculate percentage based on mouse Y position
        // Approximate: toolbar ~50px, input+operations can be 30-80% of space
        var percent = (e.ClientY - 80) / 5;
        _inputHeightPercent = Math.Clamp(percent, 30, 80);
        StateHasChanged();
    }

    private async Task SaveToNote()
    {
        string content = GetOutputContent();
        if (string.IsNullOrEmpty(content)) return;

        // Create a new note with the output content
        var note = await NoteService.CreateNoteAsync();
        note.Content = $"<pre style=\"font-family: 'Cascadia Code', monospace; white-space: pre-wrap;\">{System.Net.WebUtility.HtmlEncode(content)}</pre>";
        await NoteService.SaveNoteAsync(note);

        // Navigate to notes
        NavigationService.SetActiveItem("notes");
    }

    private string GetOutputContent()
    {
        if (_jwtResult != null && _jwtResult.Success)
        {
            return $"=== JWT Header ===\n{_jwtResult.HeaderJson}\n\n=== JWT Payload ===\n{_jwtResult.PayloadJson}\n\n=== Signature ===\n{_jwtResult.Signature}";
        }
        return _output;
    }
}
