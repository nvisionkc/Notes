@inherits LayoutComponentBase
@inject IThemeService ThemeService
@implements IDisposable

<div class="app-container @ThemeClass">
    <div class="sidebar-panel">
        <div class="tab-bar">
            <button class="tab @(ActiveTab == "notes" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("notes"))">
                Notes
            </button>
            <button class="tab @(ActiveTab == "clipboard" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("clipboard"))">
                Clipboard
            </button>
            <button class="tab @(ActiveTab == "scripts" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("scripts"))">
                Scripts
            </button>
            <button class="pin-button @(_isPinned ? "pinned" : "")"
                    @onclick="TogglePin"
                    title="@(_isPinned ? "Unpin window (make draggable)" : "Pin to bottom-right")">
                <span class="pin-icon">@(_isPinned ? "üìå" : "üìç")</span>
            </button>
        </div>

        @if (ActiveTab == "notes")
        {
            <Sidebar @ref="_sidebar"
                     SelectedNoteId="@SelectedNoteId"
                     SelectedNoteIdChanged="OnNoteSelected"
                     OnNewNote="OnNewNote"
                     OnNoteDeleted="OnNoteDeleted" />
        }
        else if (ActiveTab == "clipboard")
        {
            <ClipboardHistory OnConvertToNote="ConvertClipboardToNote"
                              OnItemSelected="OnClipboardItemSelected" />
        }
        else if (ActiveTab == "scripts")
        {
            <ScriptsPanel @ref="_scriptsPanel"
                          SelectedScriptId="@SelectedScriptId"
                          SelectedScriptIdChanged="OnScriptSelected"
                          OnNewScript="OnNewScript"
                          OnScriptDeleted="OnScriptDeleted" />
        }

    </div>

    <main class="main-content">
        <CascadingValue Value="this">
            @Body
        </CascadingValue>
    </main>
</div>

@code {
    private Sidebar? _sidebar;
    private ScriptsPanel? _scriptsPanel;
    private bool _isPinned = true;
    public int? SelectedNoteId { get; private set; }
    public int? SelectedScriptId { get; private set; }
    public string ActiveTab { get; private set; } = "notes";
    public event Func<int?, Task>? NoteSelectionChanged;
    public event Func<Task>? NewNoteRequested;
    public event Func<int, Task>? NoteDeleteRequested;
    public event Func<string, bool, Task>? ClipboardConvertRequested;
    public event Func<string, bool, Task>? ClipboardItemSelected;
    public event Func<int?, Task>? ScriptSelectionChanged;
    public event Func<Task>? NewScriptRequested;
    public event Func<int, Task>? ScriptDeleteRequested;
    public event Func<int, Task>? ScriptSaved;

#if WINDOWS
    [Inject] private Notes.Services.ClipboardService? ClipboardService { get; set; }
    [Inject] private Notes.Services.TrayService? TrayService { get; set; }
#endif

    private string ThemeClass => ThemeService.IsDarkMode ? "dark-theme" : "light-theme";

    protected override async Task OnInitializedAsync()
    {
        await ThemeService.InitializeAsync();
        ThemeService.ThemeChanged += OnThemeChanged;

#if WINDOWS
        if (ClipboardService != null)
        {
            ClipboardService.NotificationClicked += OnNotificationClicked;
        }
        if (TrayService != null)
        {
            _isPinned = TrayService.IsPinned;
            TrayService.PinStateChanged += OnPinStateChanged;
        }
#endif
    }

    private void TogglePin()
    {
#if WINDOWS
        TrayService?.TogglePin();
#endif
    }

    private void OnPinStateChanged(bool isPinned)
    {
        _isPinned = isPinned;
        InvokeAsync(StateHasChanged);
    }

    private void OnNotificationClicked(int clipboardId)
    {
        InvokeAsync(async () =>
        {
#if WINDOWS
            var item = ClipboardService?.GetItemById(clipboardId);
            if (item != null)
            {
                // Switch to clipboard tab and display content
                ActiveTab = "clipboard";
                StateHasChanged();

                // Trigger the item to be displayed
                if (ClipboardItemSelected != null)
                {
                    await ClipboardItemSelected.Invoke(item.Content, item.IsImage);
                }
            }
#endif
        });
    }

    private void OnThemeChanged(bool isDark)
    {
        InvokeAsync(StateHasChanged);
    }

    private void SetActiveTab(string tab)
    {
        ActiveTab = tab;
        StateHasChanged();
    }

    private async Task OnNoteSelected(int? noteId)
    {
        SelectedNoteId = noteId;
        if (NoteSelectionChanged != null)
        {
            await NoteSelectionChanged.Invoke(noteId);
        }
    }

    private async Task OnNewNote()
    {
        SelectedNoteId = null;
        if (NewNoteRequested != null)
        {
            await NewNoteRequested.Invoke();
        }
    }

    private async Task OnNoteDeleted(int noteId)
    {
        if (SelectedNoteId == noteId)
        {
            SelectedNoteId = null;
        }
        if (NoteDeleteRequested != null)
        {
            await NoteDeleteRequested.Invoke(noteId);
        }
    }

    private async Task OnScriptSelected(int? scriptId)
    {
        SelectedScriptId = scriptId;
        if (ScriptSelectionChanged != null)
        {
            await ScriptSelectionChanged.Invoke(scriptId);
        }
    }

    private async Task OnNewScript()
    {
        SelectedScriptId = null;
        if (NewScriptRequested != null)
        {
            await NewScriptRequested.Invoke();
        }
    }

    private async Task OnScriptDeleted(int scriptId)
    {
        if (SelectedScriptId == scriptId)
        {
            SelectedScriptId = null;
        }
        if (ScriptDeleteRequested != null)
        {
            await ScriptDeleteRequested.Invoke(scriptId);
        }
    }

    public async Task OnScriptSaved(int scriptId)
    {
        SelectedScriptId = scriptId;
        if (_scriptsPanel != null)
        {
            await _scriptsPanel.RefreshScriptsAsync();
        }
        if (ScriptSaved != null)
        {
            await ScriptSaved.Invoke(scriptId);
        }
        StateHasChanged();
    }

    private async Task ConvertClipboardToNote((string Content, bool IsImage) data)
    {
        ActiveTab = "notes";
        SelectedNoteId = null;
        if (ClipboardConvertRequested != null)
        {
            await ClipboardConvertRequested.Invoke(data.Content, data.IsImage);
        }
        StateHasChanged();
    }

    private async Task OnClipboardItemSelected((string Content, bool IsImage) data)
    {
        if (ClipboardItemSelected != null)
        {
            await ClipboardItemSelected.Invoke(data.Content, data.IsImage);
        }
    }

    public async Task RefreshSidebar()
    {
        if (_sidebar != null)
        {
            await _sidebar.RefreshNotesAsync();
        }
    }

    public void SetSelectedNoteId(int id)
    {
        SelectedNoteId = id;
        StateHasChanged();
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
#if WINDOWS
        if (ClipboardService != null)
        {
            ClipboardService.NotificationClicked -= OnNotificationClicked;
        }
        if (TrayService != null)
        {
            TrayService.PinStateChanged -= OnPinStateChanged;
        }
#endif
    }
}
