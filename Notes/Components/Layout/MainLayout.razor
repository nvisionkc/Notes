@inherits LayoutComponentBase
@inject IThemeService ThemeService
@inject INavigationService NavigationService
@implements IDisposable

<div class="app-container @ThemeClass @(_isChatOpen ? "chat-open" : "")">
    <IconRail OnAIChatToggle="ToggleAIChat" IsChatOpen="_isChatOpen" />
    <CommandPalette />
    <AIChatPanel IsOpen="_isChatOpen" OnClose="() => _isChatOpen = false" />

    @if (IsFullPanelView)
    {
        <!-- Full-panel views (no sidebar) -->
        <div class="full-panel-content">
            @switch (NavigationService.ActiveItemId)
            {
                case "data-viewer":
                    <DataViewerPanel />
                    break;
                case "encoder":
                    <EncoderPanel />
                    break;
                case "diff":
                    <DiffPanel />
                    break;
                case "ports":
                    <PortFinderPanel />
                    break;
                case "ai-settings":
                    <AISettingsPanel />
                    break;
            }
        </div>
    }
    else
    {
        <!-- Standard sidebar + main content layout -->
        <div class="sidebar-panel">
            @switch (NavigationService.ActiveItemId)
            {
                case "notes":
                    <Sidebar @ref="_sidebar"
                             SelectedNoteId="@SelectedNoteId"
                             SelectedNoteIdChanged="OnNoteSelected"
                             OnNewNote="OnNewNote"
                             OnNoteDeleted="OnNoteDeleted" />
                    break;
                case "clipboard":
                    <ClipboardHistory OnConvertToNote="ConvertClipboardToNote"
                                      OnItemSelected="OnClipboardItemSelected" />
                    break;
                case "scripts":
                    <ScriptsPanel @ref="_scriptsPanel"
                                  SelectedScriptId="@SelectedScriptId"
                                  SelectedScriptIdChanged="OnScriptSelected"
                                  OnNewScript="OnNewScript"
                                  OnScriptDeleted="OnScriptDeleted" />
                    break;
            }
        </div>

        <main class="main-content">
            <CascadingValue Value="this">
                @Body
            </CascadingValue>
        </main>
    }
</div>

@code {
    private Sidebar? _sidebar;
    private ScriptsPanel? _scriptsPanel;
    public int? SelectedNoteId { get; private set; }
    public int? SelectedScriptId { get; private set; }

    // Full-panel views don't use sidebar + main content layout
    private static readonly HashSet<string> FullPanelViews = new() { "data-viewer", "encoder", "diff", "ports", "ai-settings" };
    private bool IsFullPanelView => FullPanelViews.Contains(NavigationService.ActiveItemId);

    // AI Chat panel state
    private bool _isChatOpen;

    private void ToggleAIChat()
    {
        _isChatOpen = !_isChatOpen;
    }

    // Backwards compatibility - expose ActiveTab via NavigationService
    public string ActiveTab => NavigationService.ActiveItemId;

    public event Func<int?, Task>? NoteSelectionChanged;
    public event Func<Task>? NewNoteRequested;
    public event Func<int, Task>? NoteDeleteRequested;
    public event Func<string, bool, Task>? ClipboardConvertRequested;
    public event Func<string, bool, Task>? ClipboardItemSelected;
    public event Func<int?, Task>? ScriptSelectionChanged;
    public event Func<Task>? NewScriptRequested;
    public event Func<int, Task>? ScriptDeleteRequested;
    public event Func<int, Task>? ScriptSaved;

#if WINDOWS
    [Inject] private ClipboardService? ClipboardService { get; set; }
#endif

    private string ThemeClass => ThemeService.IsDarkMode ? "dark-theme" : "light-theme";

    protected override async Task OnInitializedAsync()
    {
        // Register built-in navigation items
        RegisterBuiltInNavItems();

        // Load saved navigation state
        await NavigationService.LoadStateAsync();

        // Subscribe to navigation changes
        NavigationService.NavigationChanged += OnNavigationChanged;

        await ThemeService.InitializeAsync();
        ThemeService.ThemeChanged += OnThemeChanged;

#if WINDOWS
        if (ClipboardService != null)
        {
            ClipboardService.NotificationClicked += OnNotificationClicked;
        }
#endif
    }

    private void RegisterBuiltInNavItems()
    {
        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "notes",
            Label = "Notes",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z\"/></svg>",
            IconType = "svg",
            Order = 10
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "clipboard",
            Label = "Clipboard",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z\"/><path d=\"M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z\"/></svg>",
            IconType = "svg",
            Order = 20
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "scripts",
            Label = "Scripts",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l-3.5-3.5a.5.5 0 0 0-.708 0z\"/></svg>",
            IconType = "svg",
            Order = 30
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "data-viewer",
            Label = "JSON/XML",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M2.114 8.063V7.9c1.005-.102 1.497-.615 1.497-1.6V4.503c0-1.094.39-1.538 1.354-1.538h.273V2h-.376C3.25 2 2.49 2.759 2.49 4.352v1.524c0 1.094-.376 1.456-1.49 1.456v1.299c1.114 0 1.49.362 1.49 1.456v1.524c0 1.593.759 2.352 2.372 2.352h.376v-.964h-.273c-.964 0-1.354-.444-1.354-1.538V9.663c0-.984-.492-1.497-1.497-1.6zM13.886 7.9v.163c-1.005.103-1.497.616-1.497 1.6v1.798c0 1.094-.39 1.538-1.354 1.538h-.273v.964h.376c1.613 0 2.372-.759 2.372-2.352v-1.524c0-1.094.376-1.456 1.49-1.456V7.332c-1.114 0-1.49-.362-1.49-1.456V4.352C13.51 2.759 12.75 2 11.138 2h-.376v.964h.273c.964 0 1.354.444 1.354 1.538V6.3c0 .984.492 1.497 1.497 1.6z\"/></svg>",
            IconType = "svg",
            Order = 40
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "encoder",
            Label = "Encode",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\" style=\"font-family:monospace;font-weight:bold;font-size:8px\"><text x=\"0\" y=\"7\">0101</text><text x=\"0\" y=\"15\">1100</text></svg>",
            IconType = "svg",
            Order = 50
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "diff",
            Label = "Diff",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path fill-rule=\"evenodd\" d=\"M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z\"/></svg>",
            IconType = "svg",
            Order = 60
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "ports",
            Label = "Ports",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M2 3h12v8H2V3zm1 1v6h10V4H3zm1 1h1v4H4V5zm2 0h1v4H6V5zm2 0h1v4H8V5zm2 0h1v4h-1V5zm2 0h1v4h-1V5z\"/><path d=\"M4 11h8v2H4v-2zm1 .5h1v1H5v-1zm2 0h1v1H7v-1zm2 0h1v1H9v-1zm2 0h1v1h-1v-1z\"/></svg>",
            IconType = "svg",
            Order = 70
        });

        NavigationService.RegisterNavItem(new Models.NavItem
        {
            Id = "ai-settings",
            Label = "AI Settings",
            Icon = "<svg width=\"20\" height=\"20\" viewBox=\"0 0 16 16\" fill=\"currentColor\"><path d=\"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z\"/><path d=\"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z\"/></svg>",
            IconType = "svg",
            Order = 90
        });
    }

    private void OnNavigationChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnNotificationClicked(int clipboardId)
    {
        InvokeAsync(async () =>
        {
#if WINDOWS
            var item = ClipboardService?.GetItemById(clipboardId);
            if (item != null)
            {
                // Switch to clipboard tab and display content
                NavigationService.SetActiveItem("clipboard");
                StateHasChanged();

                // Trigger the item to be displayed
                if (ClipboardItemSelected != null)
                {
                    await ClipboardItemSelected.Invoke(item.Content, item.IsImage);
                }
            }
#endif
        });
    }

    private void OnThemeChanged(bool isDark)
    {
        InvokeAsync(StateHasChanged);
    }

    // For backwards compatibility with Home.razor
    public void SetActiveTab(string tab)
    {
        NavigationService.SetActiveItem(tab);
    }

    private async Task OnNoteSelected(int? noteId)
    {
        SelectedNoteId = noteId;
        if (NoteSelectionChanged != null)
        {
            await NoteSelectionChanged.Invoke(noteId);
        }
    }

    private async Task OnNewNote()
    {
        SelectedNoteId = null;
        if (NewNoteRequested != null)
        {
            await NewNoteRequested.Invoke();
        }
    }

    private async Task OnNoteDeleted(int noteId)
    {
        if (SelectedNoteId == noteId)
        {
            SelectedNoteId = null;
        }
        if (NoteDeleteRequested != null)
        {
            await NoteDeleteRequested.Invoke(noteId);
        }
    }

    private async Task OnScriptSelected(int? scriptId)
    {
        SelectedScriptId = scriptId;
        if (ScriptSelectionChanged != null)
        {
            await ScriptSelectionChanged.Invoke(scriptId);
        }
    }

    private async Task OnNewScript()
    {
        SelectedScriptId = null;
        if (NewScriptRequested != null)
        {
            await NewScriptRequested.Invoke();
        }
    }

    private async Task OnScriptDeleted(int scriptId)
    {
        if (SelectedScriptId == scriptId)
        {
            SelectedScriptId = null;
        }
        if (ScriptDeleteRequested != null)
        {
            await ScriptDeleteRequested.Invoke(scriptId);
        }
    }

    public async Task OnScriptSaved(int scriptId)
    {
        SelectedScriptId = scriptId;
        if (_scriptsPanel != null)
        {
            await _scriptsPanel.RefreshScriptsAsync();
        }
        if (ScriptSaved != null)
        {
            await ScriptSaved.Invoke(scriptId);
        }
        StateHasChanged();
    }

    private async Task ConvertClipboardToNote((string Content, bool IsImage) data)
    {
        NavigationService.SetActiveItem("notes");
        SelectedNoteId = null;
        if (ClipboardConvertRequested != null)
        {
            await ClipboardConvertRequested.Invoke(data.Content, data.IsImage);
        }
        StateHasChanged();
    }

    private async Task OnClipboardItemSelected((string Content, bool IsImage) data)
    {
        if (ClipboardItemSelected != null)
        {
            await ClipboardItemSelected.Invoke(data.Content, data.IsImage);
        }
    }

    public async Task RefreshSidebar()
    {
        if (_sidebar != null)
        {
            await _sidebar.RefreshNotesAsync();
        }
    }

    public void SetSelectedNoteId(int id)
    {
        SelectedNoteId = id;
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationService.NavigationChanged -= OnNavigationChanged;
        ThemeService.ThemeChanged -= OnThemeChanged;
#if WINDOWS
        if (ClipboardService != null)
        {
            ClipboardService.NotificationClicked -= OnNotificationClicked;
        }
#endif
    }
}
