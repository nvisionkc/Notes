@inject INavigationService NavigationService
@inject ICommandService CommandService
@implements IDisposable

<nav class="icon-rail @(NavigationService.IsRailExpanded ? "expanded" : "")">
    <div class="rail-items">
        @foreach (var item in NavigationService.NavItems)
        {
            <button class="rail-item @(NavigationService.ActiveItemId == item.Id ? "active" : "")"
                    @onclick="() => SelectItem(item.Id)"
                    title="@(NavigationService.IsRailExpanded ? "" : item.Label)">
                <span class="rail-icon">
                    @if (item.IconType == "svg")
                    {
                        @((MarkupString)item.Icon)
                    }
                    else
                    {
                        @item.Icon
                    }
                </span>
                <span class="rail-label">@item.Label</span>
            </button>
        }
    </div>

    <div class="rail-footer">
        <button class="rail-item ai-chat-item @(IsChatOpen ? "active" : "")"
                @onclick="ToggleAIChat"
                title="@(NavigationService.IsRailExpanded ? "" : "AI Assistant")">
            <span class="rail-icon">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.828 1.828l1.937.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.828l-.645 1.937a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69a1.734 1.734 0 0 0-1.097-1.097l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.099z"/>
                </svg>
            </span>
            <span class="rail-label">AI Chat</span>
        </button>
        <button class="rail-item search-item"
                @onclick="OpenCommandPalette"
                title="@(NavigationService.IsRailExpanded ? "" : "Command Palette (Ctrl+Shift+K)")">
            <span class="rail-icon">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm2-1a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/>
                    <path d="M3.5 6L6 8.5 3.5 11l-.707-.707L5.086 8.5 2.793 6.707 3.5 6zm4.5 5h4v1H8v-1z"/>
                </svg>
            </span>
            <span class="rail-label">Commands</span>
        </button>
        @if (_showPinButton)
        {
            <button class="rail-item pin-item @(_isPinned ? "pinned" : "")"
                    @onclick="TogglePin"
                    title="@(NavigationService.IsRailExpanded ? "" : (_isPinned ? "Unpin window" : "Pin to corner"))">
                <span class="rail-icon">
                    @if (_isPinned)
                    {
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 0 1 1.013.16l3.134-3.133a2.772 2.772 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146z"/>
                        </svg>
                    }
                    else
                    {
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M9.828.722a.5.5 0 0 1 .354.146l4.95 4.95a.5.5 0 0 1 0 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 0 1 .16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 0 1-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 0 1 0-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 0 1 1.013.16l3.134-3.133a2.772 2.772 0 0 1-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 0 1 .353-.146zm.122 2.112v-.002.002zm0-.002v.002a.5.5 0 0 1-.122.51L6.293 6.878a.5.5 0 0 1-.511.12H5.78l-.014-.004a4.507 4.507 0 0 0-.288-.076 4.922 4.922 0 0 0-.765-.116c-.422-.028-.836.008-1.175.15l5.51 5.509c.141-.34.177-.753.149-1.175a4.924 4.924 0 0 0-.192-1.054l-.004-.013v-.001a.5.5 0 0 1 .12-.512l3.536-3.535a.5.5 0 0 1 .532-.115l.096.022c.087.017.208.034.344.034.114 0 .23-.011.343-.04L9.927 2.028c-.029.113-.04.23-.04.343a1.779 1.779 0 0 0 .062.46z"/>
                        </svg>
                    }
                </span>
                <span class="rail-label">@(_isPinned ? "Pinned" : "Pin Window")</span>
            </button>
        }
        <button class="rail-item expand-toggle"
                @onclick="ToggleExpand"
                title="@(NavigationService.IsRailExpanded ? "" : "Expand menu")">
            <span class="rail-icon chevron-icon">
                @if (NavigationService.IsRailExpanded)
                {
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                }
                else
                {
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                }
            </span>
            <span class="rail-label">@(NavigationService.IsRailExpanded ? "Collapse" : "Expand")</span>
        </button>
    </div>
</nav>

@code {
    [Parameter] public EventCallback OnAIChatToggle { get; set; }
    [Parameter] public bool IsChatOpen { get; set; }

    private bool _isPinned = true;
    private bool _showPinButton;

#if WINDOWS
    [Inject] private TrayService? TrayService { get; set; }
#endif

    private async Task ToggleAIChat()
    {
        await OnAIChatToggle.InvokeAsync();
    }

    protected override void OnInitialized()
    {
        NavigationService.NavigationChanged += OnNavigationChanged;
        NavigationService.RailExpandedChanged += OnRailExpandedChanged;

#if WINDOWS
        _showPinButton = true;
        if (TrayService != null)
        {
            _isPinned = TrayService.IsPinned;
            TrayService.PinStateChanged += OnPinStateChanged;
        }
#endif
    }

    private void SelectItem(string itemId)
    {
        NavigationService.SetActiveItem(itemId);
    }

    private void OpenCommandPalette()
    {
        CommandService.RequestOpenPalette();
    }

    private void ToggleExpand()
    {
        NavigationService.ToggleRailExpanded();
    }

    private void TogglePin()
    {
#if WINDOWS
        TrayService?.TogglePin();
#endif
    }

    private void OnPinStateChanged(bool isPinned)
    {
        _isPinned = isPinned;
        InvokeAsync(StateHasChanged);
    }

    private void OnNavigationChanged() => InvokeAsync(StateHasChanged);
    private void OnRailExpandedChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        NavigationService.NavigationChanged -= OnNavigationChanged;
        NavigationService.RailExpandedChanged -= OnRailExpandedChanged;

#if WINDOWS
        if (TrayService != null)
        {
            TrayService.PinStateChanged -= OnPinStateChanged;
        }
#endif
    }
}
